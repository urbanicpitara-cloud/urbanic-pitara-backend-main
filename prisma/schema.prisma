generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * * ENUMS **
 */
enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELED
  REFUNDED
}

enum PaymentStatus {
  INITIATED
  PAID
  FAILED
  REFUNDED
  NONE
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

enum PaymentMethod {
  COD // Cash on delivery
  STRIPE
  RAZORPAY
  PHONEPE
  PAYPAL
  // add more providers as needed
}

/**
 * * MODELS **
 */

model Collection {
  id              String  @id @default(cuid())
  handle          String  @unique
  title           String
  description     String?
  descriptionHtml String?
  imageUrl        String?
  imageAlt        String?

  products Product[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @default(now()) @updatedAt
  deletedAt DateTime? // soft-delete

  @@index([handle])
}

model Product {
  id              String       @id @default(cuid())
  handle          String       @unique
  title           String
  vendor          String?
  description     String?
  descriptionHtml String?
  collections     Collection[]

  tags ProductTag[]

  featuredImageUrl String?
  featuredImageAlt String?

  images        ProductImage[]
  options       ProductOption[]
  variants      ProductVariant[]
  reviews       Review[]
  wishlistItems WishlistItem[]

  metafields  Json?
  published   Boolean   @default(true)
  publishedAt DateTime?
  deletedAt   DateTime? // soft-delete

  cartLines  CartLine[]  @relation("CartLine_Product")
  orderItems OrderItem[] @relation("OrderItem_Product")

  minPriceAmount   Decimal @db.Decimal(10, 2)
  minPriceCurrency String
  maxPriceAmount   Decimal @db.Decimal(10, 2)
  maxPriceCurrency String

  compareMinAmount   Decimal? @db.Decimal(10, 2)
  compareMinCurrency String?
  compareMaxAmount   Decimal? @db.Decimal(10, 2)
  compareMaxCurrency String?

  // SEO
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?

  // Aggregates
  averageRating Float? @default(0)
  reviewCount   Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // Variant Grouping
  variantGroup   VariantGroup? @relation(fields: [variantGroupId], references: [id])
  variantGroupId String?

  @@index([handle])
  @@index([published])
}

model VariantGroup {
  id          String    @id @default(cuid())
  name        String? // e.g. "Velvet Kurtis Collection"
  description String?
  products    Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model ProductImage {
  id        String  @id @default(cuid())
  url       String
  altText   String?
  product   Product @relation(fields: [productId], references: [id])
  productId String
}

model ProductOption {
  id        String               @id @default(cuid())
  name      String
  product   Product              @relation(fields: [productId], references: [id])
  productId String
  values    ProductOptionValue[]
}

model ProductOptionValue {
  id       String        @id @default(cuid())
  name     String
  color    String?
  option   ProductOption @relation(fields: [optionId], references: [id])
  optionId String
}

model ProductVariant {
  id               String   @id @default(cuid())
  product          Product  @relation(fields: [productId], references: [id])
  productId        String
  availableForSale Boolean  @default(true)
  priceAmount      Decimal  @db.Decimal(10, 2)
  priceCurrency    String
  compareAmount    Decimal? @db.Decimal(10, 2)
  compareCurrency  String?

  sku               String?
  barcode           String?
  inventoryQuantity Int     @default(0)
  lowStockThreshold Int?    @default(5)
  weightInGrams     Int?

  selectedOptions Json

  cartLines  CartLine[]  @relation("CartLine_Variant")
  orderItems OrderItem[] @relation("OrderItem_Variant")

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([sku])
}


model User {
  id               String          @id @default(cuid())
  email            String          @unique
  passwordHash     String
  firstName        String?
  lastName         String?
  isAdmin          Boolean         @default(false)
  phone            String?
  addresses        Address[]
  orders           Order[]
  carts            Cart[]
  wishlists        Wishlist[]
  reviews          Review[]
  resetToken       String?
  resetTokenExpiry DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @default(now()) @updatedAt
  deletedAt        DateTime? // soft-delete
  customProducts   CustomProduct[]

  @@index([email])
}

model Address {
  id          String  @id @default(cuid())
  user        User    @relation(fields: [userId], references: [id])
  userId      String
  firstName   String
  lastName    String
  address1    String
  address2    String?
  city        String
  province    String?
  zip         String?
  country     String
  countryCode String?
  phone       String?
  isDefault   Boolean @default(false)

  // back-relations for orders
  ordersAsShipping Order[] @relation("Order_ShippingAddress")
  ordersAsBilling  Order[] @relation("Order_BillingAddress")

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

/**
 * * CART **
 */
model Cart {
  id            String     @id @default(cuid())
  user          User?      @relation(fields: [userId], references: [id])
  userId        String?
  totalQuantity Int        @default(0)
  lines         CartLine[]
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @default(now()) @updatedAt
}

model CartLine {
  id            String          @id @default(cuid())
  cart          Cart            @relation(fields: [cartId], references: [id])
  cartId        String
  product       Product?        @relation("CartLine_Product", fields: [productId], references: [id])
  productId     String?
  variant       ProductVariant? @relation("CartLine_Variant", fields: [variantId], references: [id])
  variantId     String?
  quantity      Int             @default(1)
  priceAmount   Decimal         @db.Decimal(10, 2)
  priceCurrency String

  customProduct   CustomProduct? @relation(fields: [customProductId], references: [id])
  customProductId String?
}

/**
 * * ORDERS **
 */
model Order {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id])
  userId String

  //   // Legacy - keep for now (string) so existing app doesn't break
  status        OrderStatus? @default(PENDING)
  totalAmount   String
  totalCurrency String

  orderNumber String?
  paymentId   String? // link to Payment model
  payment     Payment?

  placedAt          DateTime    @default(now())
  items             OrderItem[]
  shippingAddressId String?
  shippingAddress   Address?    @relation("Order_ShippingAddress", fields: [shippingAddressId], references: [id])
  billingAddressId  String?
  billingAddress    Address?    @relation("Order_BillingAddress", fields: [billingAddressId], references: [id])
  cancelReason      String?

  discountAmount    Decimal?  @default(0)
  appliedDiscountId String?
  appliedDiscount   Discount? @relation("OrderDiscount", fields: [appliedDiscountId], references: [id])

  trackingNumber  String?
  trackingCompany String?
  adminNotes      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([userId])
  @@index([status])
  @@index([placedAt])
}

/**
 * * ORDER ITEMS **
 */
model OrderItem {
  id            String          @id @default(cuid())
  order         Order           @relation(fields: [orderId], references: [id])
  orderId       String
  product       Product?        @relation("OrderItem_Product", fields: [productId], references: [id])
  productId     String?
  variant       ProductVariant? @relation("OrderItem_Variant", fields: [variantId], references: [id])
  variantId     String?
  quantity      Int
  priceAmount   Decimal         @db.Decimal(10, 2)
  priceCurrency String

  customProduct   CustomProduct? @relation(fields: [customProductId], references: [id])
  customProductId String?
}

model Tag {
  id          String       @id @default(cuid())
  handle      String       @unique
  name        String       @unique
  description String?
  products    ProductTag[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @default(now()) @updatedAt
}

/**
 * * MIDDLE TABLE **
 */
model ProductTag {
  product   Product  @relation(fields: [productId], references: [id])
  productId String
  tag       Tag      @relation(fields: [tagId], references: [id])
  tagId     String
  createdAt DateTime @default(now())

  @@id([productId, tagId])
  @@index([tagId])
  @@index([productId])
}

/**
 * * REVIEWS **
 */
model Review {
  id        String   @id @default(cuid())
  rating    Int
  title     String?
  comment   String?
  product   Product  @relation(fields: [productId], references: [id])
  productId String
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  approved  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([productId])
  @@index([userId])
}

/**
 * * WISHLIST **
 */
model Wishlist {
  id        String         @id @default(cuid())
  user      User           @relation(fields: [userId], references: [id])
  userId    String
  items     WishlistItem[]
  createdAt DateTime       @default(now())
}

model WishlistItem {
  id         String   @id @default(cuid())
  wishlist   Wishlist @relation(fields: [wishlistId], references: [id])
  wishlistId String
  product    Product  @relation(fields: [productId], references: [id])
  productId  String
  createdAt  DateTime @default(now())

  @@index([productId])
}

/**
 * * DISCOUNTS / COUPONS **
 */
model Discount {
  id             String       @id @default(cuid())
  code           String       @unique
  description    String?
  type           DiscountType
  value          Decimal      @db.Decimal(10, 2)
  minOrderAmount Decimal?     @db.Decimal(10, 2)
  active         Boolean      @default(true)
  startsAt       DateTime?
  endsAt         DateTime?
  usageLimit     Int? // null = unlimited
  orders         Order[]      @relation("OrderDiscount")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now()) @updatedAt
}

/**
 * * SUBSCRIBERS / NEWSLETTER **
 */
model Payment {
  id                String        @id @default(cuid())
  order             Order?        @relation(fields: [orderId], references: [id])
  orderId           String?       @unique
  method            PaymentMethod // new enum field
  provider          String? // optional, e.g., "stripe", "razorpay", "phonepe"
  providerOrderId   String?
  providerPaymentId String?
  amount            Decimal       @db.Decimal(10, 2)
  currency          String
  status            PaymentStatus @default(NONE) // "INITIATED", "PAID", "FAILED", "REFUNDED" "NONE"
  rawResponse       Json?

  // Refund tracking fields
  refundId     String? // Provider's refund ID (Razorpay refund_id, Stripe refund_id)
  refundAmount Decimal?  @db.Decimal(10, 2) // Amount refunded
  refundedAt   DateTime? // When refund was processed
  refundReason String? // Admin's reason for refund

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @default(now()) @updatedAt
  transaction Transaction?

  @@index([providerPaymentId])
  @@index([orderId])
}

model Transaction {
  id              String   @id
  payment         Payment? @relation(fields: [paymentId], references: [id])
  paymentId       String?  @unique
  amount          Decimal  @db.Decimal(10, 2)
  currency        String   @default("INR")
  orderId         String
  userId          String
  status          String   @default("PENDING") // PENDING, COMPLETED, FAILED
  provider        String   @default("PHONEPE")
  responseCode    String?
  responseMessage String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt

  @@index([orderId])
  @@index([userId])
  @@index([status])
}

/**
 * * PAGES / CMS **
 */


// Subscribers (newsletter signups)
model Subscriber {
  id        String   @id @default(cuid())
  email     String   @unique
  source    String? // e.g. "footer", "home"
  verified  Boolean  @default(false)
  meta      Json? // optional metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

/**
 * * SIMPLE ANALYTICS (OPTIONAL) **
 */
model EventLog {
  id        String   @id @default(cuid())
  type      String
  payload   Json?
  createdAt DateTime @default(now())
}

/**
 * * CUSTOM HOODIE SYSTEM **
 */

model HoodieTemplate {
  id       String @id @default(cuid())
  color    String
  side     String // front | back | left | right
  imageUrl String // from /public/hoodies or Cloudinary if needed

  createdAt DateTime @default(now())

  @@index([color])
  @@index([side])
}

/**
 * * SCALABLE CUSTOMIZER MODELS **
 */

model PrintableProduct {
  id          String  @id @default(cuid())
  name        String // e.g. "Premium Hoodie", "Cotton T-Shirt"
  description String?
  basePrice   Decimal @db.Decimal(10, 2)

  variants PrintableVariant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model PrintableVariant {
  id                 String           @id @default(cuid())
  printableProduct   PrintableProduct @relation(fields: [printableProductId], references: [id], onDelete: Cascade)
  printableProductId String

  colorName String // e.g. "Black", "Red"
  colorHex  String // e.g. "#000000"

  views PrintableView[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model PrintableView {
  id                 String           @id @default(cuid())
  printableVariant   PrintableVariant @relation(fields: [printableVariantId], references: [id], onDelete: Cascade)
  printableVariantId String

  side     String // "front", "back", "left", "right"
  imageUrl String // Cloudinary URL

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model ArtCategory {
  id     String     @id @default(cuid())
  name   String     @unique // "Memes", "Sports"
  assets ArtAsset[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model ArtAsset {
  id         String      @id @default(cuid())
  category   ArtCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  categoryId String

  url  String // Cloudinary URL
  name String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model CustomProduct {
  id String @id @default(cuid())

  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  title       String?
  description String?

  previewUrl String? // Cloudinary thumbnail URL
  exportUrl  String? // Cloudinary print image URL

  color     String
  size      String?
  price     Decimal @db.Decimal(10, 2)
  snapshots Json? // { front: "url", back: "url" }

  design Design?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  cartLines  CartLine[]
  orderItems OrderItem[]
}

model Design {
  id              String        @id @default(cuid())
  customProduct   CustomProduct @relation(fields: [customProductId], references: [id])
  customProductId String        @unique

  json         Json
  thumbnailUrl String? // Cloudinary
  exportUrl    String? // Cloudinary

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}
